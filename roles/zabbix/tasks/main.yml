---
- name: Download zabbix repository install file
  get_url:
    url: "{{ repo_download_url }}"
    dest: /tmp
    force: true
  register: repo_file

- name: Install Zabbix repository
  apt:
    deb: "{{ repo_file.dest }}"

- name: Update apt cache if needed.
  apt:
    update_cache: yes

- name: Install required packages for Zabbix server
  apt:
    name: "{{ item }}"
    state: present
  with_items: 
  - postgresql
  - zabbix-server-pgsql
  - zabbix-frontend-php
  - php8.1-pgsql
  - zabbix-nginx-conf
  - zabbix-sql-scripts
  - zabbix-agent

- name: Grub zabbix postgresql user password
  delegate_to: localhost
  shell: echo $PG_ZABBIX_USER_PWD > /tmp/zabbix_user_pwd.txt && chmod 400 /tmp/zabbix_user_pwd.txt

